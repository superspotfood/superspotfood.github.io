<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>711即期品查詢</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    margin: 20px;
    background-color: #f9fafb;
    font-size: 16px;
  }
  h2 { text-align: center; margin-bottom: 5px; }
  #updateTime {
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    margin: 10px 0;
    display: none;
  }
  #noDataMessage {
    text-align: center;
    color: #ef4444;
    font-size: 16px;
    margin-top: 20px;
    display: none;
  }
  select {
    padding: 10px;
    margin: 6px 8px 6px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    width: 100%;
    max-width: 280px;
  }
  .radio-group {
    margin: 10px 0;
    display: flex;
    flex-wrap: wrap;
  }
  .radio-btn {
    padding: 8px 14px;
    margin: 4px 4px; /* ✅ 商品間距微調 */
    border-radius: 6px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    user-select: none;
    transition: 0.2s;
    white-space: nowrap;
  }
  .radio-btn:hover { background-color: #f3f4f6; }
  .radio-btn.active {
    background-color: #2563eb;
    color: white;
    border-color: #1d4ed8;
  }
  /* group header / list styles (新增) */
  .group-header {
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 10px;
    margin: 6px 0;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .group-header:hover { background: #e9e9e9; }
  .group-list {
    padding: 6px 8px 12px 16px;
    display: none;
  }

  table {
    margin-top: 10px;
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #e5e7eb;
    padding: 10px;
    text-align: left;
  }
  th { background-color: #f3f4f6; }
  td.address { color: #2563eb; cursor: pointer; text-decoration: underline; }
  td.address:hover { color: #1e40af; }
  td.clickable { color: #111827; cursor: pointer; font-weight: 600; }
  tr.copied td.address { background-color: #d1fae5; transition: background-color 0.8s ease; }
  .copy-toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #16a34a; color: white; padding: 10px 20px; border-radius: 999px;
    font-size: 14px; opacity: 0; transition: opacity 0.4s; z-index: 1000;
  }
  .copy-toast.show { opacity: 1; }
  .info-box {
    margin-top: 15px; background: #fff; border-radius: 8px; padding: 12px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); line-height: 1.6;
  }
  .collapsible-row { display: none; }
  .collapsible-content { background: #f9fafb; padding: 10px; animation: fadeIn 0.3s ease; }
  .collapsible-content table {
    width: 95%; margin: 5px auto; font-size: 15px; background: #fff;
  }
  .highlight { background-color: #fff6bf !important; }
  @keyframes fadeIn {
    from { opacity: 0; transform: scaleY(0.95); }
    to { opacity: 1; transform: scaleY(1); }
  }
    .mode-btn {
    padding: 8px 14px;
    margin: 3px;
    border-radius: 6px;
    border: 1px solid #888;
    background: #f3f4f6;
    font-size: 15px;
    cursor: pointer;
  }
  .mode-btn.active {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
  }
</style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VXLJ3ZT4FR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VXLJ3ZT4FR');
</script>
</head>
<body>

<h2>711即期品查詢</h2>
<div id="modeToggle" style="margin-bottom: 15px; text-align: center;">
  <button id="modeA" class="mode-btn active">區域模式</button>
  <button id="modeB" class="mode-btn">商品搜尋模式</button>
</div>
<select id="citySelect">
  <option value="">-- 選擇城市 --</option>
</select>

<select id="townSelect" disabled>
  <option value="">-- 選擇區域 --</option>
</select>

<div id="updateTime">資料更新時間：載入中...</div>
<div id="noDataMessage">目前此區域無庫存</div>

<div id="cateContainer"></div>
<div id="scateContainer"></div>
<div id="nameContainer"></div>

<div id="infoBox" class="info-box" style="display:none;">
  <strong>類別：</strong><span id="showCate"></span><br>
  <strong>商品名稱：</strong><span id="showItem"></span>
</div>

<div style="overflow-x:auto;">
<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th>店ID</th>
      <th>店名</th>
      <th>庫存</th>
      <th>地址（點擊可複製）</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<div id="toast" class="copy-toast">地址已複製</div>

<script>
const citySelect = document.getElementById('citySelect');
const townSelect = document.getElementById('townSelect');
const updateTimeDiv = document.getElementById('updateTime');
const noDataMessage = document.getElementById('noDataMessage');
const cateContainer = document.getElementById('cateContainer');
const scateContainer = document.getElementById('scateContainer');
const nameContainer = document.getElementById('nameContainer');
const resultTable = document.getElementById('resultTable');
const resultBody = resultTable.querySelector('tbody');
const toast = document.getElementById('toast');
const infoBox = document.getElementById('infoBox');
const showCate = document.getElementById('showCate');
const showItem = document.getElementById('showItem');

let allZipData = [];
let allData = [];
let selectedCate = null, selectedScate = null, selectedName = null;
let lastSelectedTown = "";
let cityData = null;    // 讀取後的 {ccode}.json
let ccodeMap = {};      // city → ccode 快取

// 模式 A = 區域模式（列出整區店家）
// 模式 B = 商品搜尋模式（你現在的原本流程）
let currentMode = 'A';

// UI 切換
document.getElementById('modeA').addEventListener('click', () => {
  currentMode = 'A';
  document.getElementById('modeA').classList.add('active');
  document.getElementById('modeB').classList.remove('active');
  resetAll();
  refreshTowns();
});

document.getElementById('modeB').addEventListener('click', () => {
  currentMode = 'B';
  document.getElementById('modeB').classList.add('active');
  document.getElementById('modeA').classList.remove('active');
  resetAll();
  refreshTowns();
});

// 清除畫面所有內容（切換模式或城市時用）
function resetAll() {
  townSelect.innerHTML = '<option value="">-- 選擇區域 --</option>';
  cateContainer.innerHTML = '';
  scateContainer.innerHTML = '';
  nameContainer.innerHTML = '';
  resultBody.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';
}

function resetAfterTown() {
  // 清空後續所有選項
  cateContainer.innerHTML = '';
  scateContainer.innerHTML = '';
  nameContainer.innerHTML = '';

  // 清空表格內容
  resultBody.innerHTML = '';
  resultTable.style.display = 'none';

  // 清空其他提示
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';
}

// 重新填充 townSelect（優先使用 cityData.town，否則 fallback zipcode.json）
function refreshTowns() {
  const city = citySelect.value;
  townSelect.innerHTML = '<option value="">-- 選擇區域 --</option>';
  townSelect.disabled = true;

  if (!city) return;
  // 如果目前有載入的 cityData (例如已經 fetch 過 ccode.json)，優先用它
  if (cityData && cityData.town && Array.isArray(cityData.town)) {
    cityData.town.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.town;
      opt.textContent = t.town;
      townSelect.appendChild(opt);
    });
    townSelect.disabled = false;
    if (lastSelectedTown) {
      const option = [...townSelect.options].find(o => o.value === lastSelectedTown);
      if (option) {
        townSelect.value = lastSelectedTown;
      // 如果你希望自動觸發該 town 的事件（重新顯示內容），加這行
        townSelect.dispatchEvent(new Event('change'));
      }
    }
    return;
  }

  // fallback：使用 zipcode.json 的內容來建 town
  const townsFromZip = allZipData.filter(z => z.city === city).map(z => z.town);
  const uniqueTowns = [...new Set(townsFromZip)];
  uniqueTowns.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    townSelect.appendChild(opt);
  });
  townSelect.disabled = uniqueTowns.length === 0;
}




function formatTimestamp(ts) {
  const date = new Date(ts * 1000);
  return date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
}
function showToast() {
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1200);
}
function copyToClipboard(text, row) {
  navigator.clipboard.writeText(text).then(() => {
    row.classList.add('copied');
    showToast();
    setTimeout(() => row.classList.remove('copied'), 800);
  });
}



/* =====================
   載入 zipcode.json
   ===================== */
async function loadZipData() {
  const res = await fetch('/711/zipcode.json');
  allZipData = await res.json();

  // 建立 city → ccode 對照表
  allZipData.forEach(z => {
    ccodeMap[z.city] = z.ccode;
  });

  const cities = [...new Set(allZipData.map(z => z.city))];
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    citySelect.appendChild(opt);
  });
}

/* =====================
   選 City → 讀取 ccode.json
   ===================== */
citySelect.addEventListener('change', async () => {
  const city = citySelect.value;

  townSelect.innerHTML = '<option value="">-- 選擇區域 --</option>';
  townSelect.disabled = true;

  cateContainer.innerHTML = scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';
  updateTimeDiv.style.display = 'none';
  resetAfterTown();
  if (!city) {
    // 清空 cityData 保障行為一致
    
    cityData = null;
    refreshTowns();
    return;
  }
  const ccode = ccodeMap[city];
  if (!ccode) {
    cityData = null;
    refreshTowns();
    return;
  }

  try {
    const res = await fetch(`/711/data/${ccode}.json`);
    cityData = await res.json();

    updateTimeDiv.textContent =
      '資料更新時間：' + formatTimestamp(cityData.updatetime);
    updateTimeDiv.style.display = 'block';

    // 將 town[] 層級填入選單
    cityData.town.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.town;
      opt.textContent = t.town;
      townSelect.appendChild(opt);
    });

    townSelect.disabled = false;

  } catch (e) {
    console.error('讀取城市資料失敗：', e);
    noDataMessage.textContent = '無法載入城市資料';
    noDataMessage.style.display = 'block';
  }
  refreshTowns();
});

/* =====================
   選 Town → 從 cityData 裡取該區 data[]
   ===================== */
townSelect.addEventListener('change', () => {
  const town = townSelect.value;
  lastSelectedTown = townSelect.value;  // 記憶最後選的 town
//  resetAll();
  resetAfterTown();

  if (!town) return;

  const townInfo = cityData.town.find(t => t.town === town);
  if (!townInfo) return;

  allData = townInfo.data || [];

  // === 分模式 ===

  if (currentMode === 'A') {
    // ---- 區域模式：直接列出所有店 ----
    showTownStores(allData);
    return;
  }

  // ---- 商品搜尋模式（原本模式）----
  buildCateOptions(allData);
});


function showTownStores(storeList) {
  if (!storeList || storeList.length === 0) {
    noDataMessage.textContent = '此區無資料';
    noDataMessage.style.display = 'block';
    return;
  }

  resultBody.innerHTML = '';
  resultTable.style.display = 'table'; // 顯示 table

  storeList.forEach(store => {
    // 注意：此 table header 有 4 欄 (id, name, qty, address)
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="clickable">${store.id}</td>
      <td class="clickable">${store.name}</td>
      <td>${/* 區域模式下沒有特定商品庫存，顯示總商品數或空白 */ (store.data ? store.data.length : '')}</td>
      <td class="address">${store.address}</td>
    `;

    // collapse row 必須 colspan = 4 (對應 header 四欄)
    const collapseRow = document.createElement('tr');
    collapseRow.classList.add('collapsible-row');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.classList.add('collapsible-content');
    td.innerHTML = createProductTable(store.data); // 顯示該店所有商品
    collapseRow.appendChild(td);

    // 點地址複製
    const addrCell = tr.querySelector('.address');
    if (addrCell) addrCell.addEventListener('click', () => copyToClipboard(store.address, tr));

    // 手風琴：一次只開一個
    tr.querySelectorAll('.clickable').forEach(cell => {
      cell.addEventListener('click', () => {
        const allCollapses = resultBody.querySelectorAll('.collapsible-row');
        allCollapses.forEach(r => { if (r !== collapseRow) r.style.display = 'none'; });
        collapseRow.style.display = (collapseRow.style.display === 'table-row') ? 'none' : 'table-row';
      });
    });

    resultBody.appendChild(tr);
    resultBody.appendChild(collapseRow);
  });
}



// 建立類別 (cate) 選項的函式（把原本的內嵌程式抽成此函式）
function buildCateOptions(storeList) {
  cateContainer.innerHTML = scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';

  if (!storeList || storeList.length === 0) {
    noDataMessage.textContent = '此區無資料';
    noDataMessage.style.display = 'block';
    return;
  }

  // 1. 擷取所有 cate
  const cates = [...new Set(storeList.flatMap(d => d.data.map(i => i.cate)).filter(Boolean))];

  if (cates.length === 0) {
    noDataMessage.textContent = '此區目前無分類資料';
    noDataMessage.style.display = 'block';
    return;
  }

  // 2. 建 UI（同你之前的風格）
  cateContainer.innerHTML =
    '<h4>選擇類別：</h4><div class="radio-group">' +
    cates.map(c => `<div class="radio-btn" data-value="${escapeHtml(c)}">${escapeHtml(c)}</div>`).join('') +
    '</div>';

  // 3. 綁定事件：點類別後顯示次分類
  cateContainer.querySelectorAll('.radio-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      cateContainer.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedCate = unescapeHtml(btn.dataset.value);
      selectedScate = selectedName = null;
      showScateOptions(selectedCate); // 你既有的函式 (不需改)
    });
  });
}


function showScateOptions(cate) {
  scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';

  const scates = [...new Set(allData.flatMap(d =>
    d.data.filter(i => i.cate === cate).map(i => i.scate)
  ).filter(Boolean))];

  scateContainer.innerHTML = '<h4>選擇次分類：</h4><div class="radio-group">' +
    scates.map(s => `<div class="radio-btn" data-value="${s}">${s}</div>`).join('') + '</div>';

  scateContainer.querySelectorAll('.radio-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      scateContainer.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedScate = btn.dataset.value;
      selectedName = null;
      showNameOptions(selectedCate, selectedScate);
    });
  });
}

/* ========== 這裡是新的 auto-smart 群組與顯示 showNameOptions() ========== */

// 自動偵測高頻前綴並分群（2~5字）
// 門檻為 count >= 5（可調）
function autoSmartGroupProducts(names, threshold = 5) {
  const prefixCount = {};
  names.forEach(name => {
    const clean = String(name).replace(/[\(\)\[\]【】★☆\s]/g, '');
    for (let len = 2; len <= 8 && len <= clean.length; len++) {
      const prefix = clean.slice(0, len);
      prefixCount[prefix] = (prefixCount[prefix] || 0) + 1;
    }
  });

  // 候選前綴（出現次數 >= threshold）
  const candidates = Object.entries(prefixCount)
    .filter(([p, c]) => c >= threshold)
    .sort((a, b) => b[0].length - a[0].length || b[1] - a[1])
    .map(([p]) => p);

  const grouped = {};
  names.forEach(name => {
    const clean = String(name).replace(/[\(\)\[\]【】★☆\s]/g, '');
    let matchedPrefix = null;
    for (const p of candidates) {
      if (clean.startsWith(p)) { matchedPrefix = p; break; }
    }
    const groupName = matchedPrefix || '其他';
    if (!grouped[groupName]) grouped[groupName] = [];
    grouped[groupName].push(name);
  });

  // 排序每個群組內的項目
  Object.keys(grouped).forEach(k => {
    grouped[k].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
  });

  // ✅ 群組排序：中文順序 + 將「其他」永遠放最後
  const sortedEntries = Object.entries(grouped).sort((a, b) => {
    if (a[0] === '其他') return 1;
    if (b[0] === '其他') return -1;
    return a[0].localeCompare(b[0], 'zh-Hant');
  });

  return Object.fromEntries(sortedEntries);
}


function showNameOptions(cate, scate) {
  nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';

  const names = [...new Set(allData
    .flatMap(d => d.data.filter(i => i.cate === cate && i.scate === scate).map(i => i.name))
    .filter(Boolean))];

  if (names.length === 0) {
    nameContainer.innerHTML = '<p>此分類目前無商品。</p>';
    return;
  }

  // 1) 用自動分群器把名稱分組
  const grouped = autoSmartGroupProducts(names, 3); // 門檻 5，可改成 4 或 3 實驗

  // 2) 建立群組 UI
  nameContainer.innerHTML = '<h4>選擇商品：</h4><div class="group-container"></div>';
  const container = nameContainer.querySelector('.group-container');

  Object.keys(grouped).forEach(group => {
    const header = document.createElement('div');
    header.className = 'group-header';
    header.textContent = `${group}（${grouped[group].length}項）`;

    const list = document.createElement('div');
    list.className = 'group-list';

    list.innerHTML = grouped[group].map(n => `<div class="radio-btn" data-value="${escapeHtml(n)}">${escapeHtml(n)}</div>`).join('');

    if(Object.keys(grouped).length>1){ 
      header.addEventListener('click', () => {
        // 收合其他 group-list，手風琴方式
        const allLists = container.querySelectorAll('.group-list');
        allLists.forEach(l => { if (l !== list) l.style.display = 'none'; });
        list.style.display = list.style.display === 'block' ? 'none' : 'block';
      });
      list.style.display = 'none';
      container.appendChild(header);
    }else{
      list.style.display = 'block';
    }

    container.appendChild(list);
  });

  // 3) 綁定每個 radio-btn 的 click（注意先生成 DOM 再綁）
  container.querySelectorAll('.radio-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const val = btn.getAttribute('data-value');
      // 反轉義 HTML 實際值
      const realVal = unescapeHtml(val);
      // 樣式
      container.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedName = realVal;
      showResults(cate, selectedName);
    });
  });
}

// 小工具：為了避免插入未轉義文字造成 HTML 問題，HTML escape/unescape
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
function unescapeHtml(escaped) {
  return String(escaped)
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#039;/g, "'");
}

/* ========== 以上為新的群組 UI 與邏輯 ========== */

function showResults(cate, item) {
  resultBody.innerHTML = '';
  const stores = allData.filter(d =>
    d.data.some(i => i.name === item && i.cate === cate)
  );

  if (stores.length === 0) {
    resultTable.style.display = 'none';
    infoBox.style.display = 'none';
    return;
  }

  showCate.textContent = cate;
  showItem.textContent = item;
  console.log(cate,item,stores[0]['city'],stores[0]['town']);
gtag('event', 'item_select', {
    'select_item': item,     // 第二個自訂參數
    'select_city': stores[0]['city'],
    'select_town': stores[0]['town'],
    'page': '711',    // **新增的第三個自訂參數：標記網站來源**
    'non_interaction': false
});  
  
  infoBox.style.display = '';
  resultTable.style.display = '';

  stores.forEach(store => {
    const matched = store.data.find(i => i.name === item && i.cate === cate);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="clickable">${store.id}</td>
      <td class="clickable">${store.name}</td>
      <td>${matched ? matched.qty : ''}</td>
      <td class="address">${store.address}</td>
    `;

    const collapseRow = document.createElement('tr');
    collapseRow.classList.add('collapsible-row');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.classList.add('collapsible-content');
    td.innerHTML = createProductTable(store.data, item);
    collapseRow.appendChild(td);

    tr.querySelector('.address').addEventListener('click', () => copyToClipboard(store.address, tr));
    tr.querySelectorAll('.clickable').forEach(cell => {
      cell.addEventListener('click', () => {
        const allCollapses = resultBody.querySelectorAll('.collapsible-row');
        allCollapses.forEach(r => { if (r !== collapseRow) r.style.display = 'none'; });
        collapseRow.style.display = (collapseRow.style.display === 'table-row') ? 'none' : 'table-row';
      });
    });

    resultBody.appendChild(tr);
    resultBody.appendChild(collapseRow);
  });
}

function createProductTable(data, selectedItem) {
  if (!data || data.length === 0) return '<em>無商品資料</em>';
  let rows = data.map(i =>
    `<tr class="${i.name === selectedItem ? 'highlight' : ''}">
      <td>${i.cate}</td><td>${i.scate}</td><td>${escapeHtml(i.name)}</td><td>${i.qty}</td>
    </tr>`
  ).join('');
  return `
    <table>
      <thead><tr><th>類別</th><th>次分類</th><th>商品名稱</th><th>數量</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

loadZipData();
</script>
</body>
</html>
