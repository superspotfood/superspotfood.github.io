<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å…¨å®¶å³æœŸå“æŸ¥è©¢</title>
<style>
  body {
    font-family: "Microsoft JhengHei", sans-serif;
    margin: 20px;
    background-color: #f9fafb;
    font-size: 16px;
  }
  h2 { text-align: center; margin-bottom: 5px; }
  #updateTime {
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    margin: 10px 0;
    display: none;
  }
  #noDataMessage {
    text-align: center;
    color: #ef4444;
    font-size: 16px;
    margin-top: 20px;
    display: none;
  }
  select {
    padding: 10px;
    margin: 6px 8px 6px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 16px;
    width: 100%;
    max-width: 280px;
  }
  .radio-group {
    margin: 10px 0;
    display: flex;
    flex-wrap: wrap;
  }
  .radio-btn {
    padding: 8px 14px;
    margin: 4px 4px; /* âœ… å•†å“é–“è·å¾®èª¿ */
    border-radius: 6px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    user-select: none;
    transition: 0.2s;
    white-space: nowrap;
  }
  .radio-btn:hover { background-color: #f3f4f6; }
  .radio-btn.active {
    background-color: #2563eb;
    color: white;
    border-color: #1d4ed8;
  }
  /* group header / list styles (æ–°å¢) */
  .group-header {
    background: #f5f5f5;
    padding: 8px 12px;
    border-radius: 10px;
    margin: 6px 0;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s;
  }
  .group-header:hover { background: #e9e9e9; }
  .group-list {
    padding: 6px 8px 12px 16px;
    display: none;
  }

  table {
    margin-top: 10px;
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #e5e7eb;
    padding: 10px;
    text-align: left;
  }
  th { background-color: #f3f4f6; }
  td.address { color: #2563eb; cursor: pointer; text-decoration: underline; }
  td.address:hover { color: #1e40af; }
  td.clickable { color: #111827; cursor: pointer; font-weight: 600; }
  tr.copied td.address { background-color: #d1fae5; transition: background-color 0.8s ease; }
  .copy-toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #16a34a; color: white; padding: 10px 20px; border-radius: 999px;
    font-size: 14px; opacity: 0; transition: opacity 0.4s; z-index: 1000;
  }
  .copy-toast.show { opacity: 1; }
  .info-box {
    margin-top: 15px; background: #fff; border-radius: 8px; padding: 12px 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); line-height: 1.6;
  }
  .collapsible-row { display: none; }
  .collapsible-content { background: #f9fafb; padding: 10px; animation: fadeIn 0.3s ease; }
  .collapsible-content table {
    width: 95%; margin: 5px auto; font-size: 15px; background: #fff;
  }
  .highlight { background-color: #fff6bf !important; }
  @keyframes fadeIn {
    from { opacity: 0; transform: scaleY(0.95); }
    to { opacity: 1; transform: scaleY(1); }
  }
</style>
</head>
<body>

<h2>å…¨å®¶å³æœŸå“æŸ¥è©¢</h2>

<select id="citySelect">
  <option value="">-- é¸æ“‡åŸå¸‚ --</option>
</select>

<select id="townSelect" disabled>
  <option value="">-- é¸æ“‡å€åŸŸ --</option>
</select>

<div id="updateTime">è³‡æ–™æ›´æ–°æ™‚é–“ï¼šè¼‰å…¥ä¸­...</div>
<div id="noDataMessage">ç›®å‰æ­¤å€åŸŸç„¡åº«å­˜</div>

<div id="cateContainer"></div>
<div id="scateContainer"></div>
<div id="nameContainer"></div>

<div id="infoBox" class="info-box" style="display:none;">
  <strong>í ½í³¦ é¡åˆ¥ï¼š</strong><span id="showCate"></span><br>
  <strong>í ¼í½± å•†å“åç¨±ï¼š</strong><span id="showItem"></span>
</div>

<div style="overflow-x:auto;">
<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th>åº—ID</th>
      <th>åº—å</th>
      <th>åº«å­˜</th>
      <th>åœ°å€ï¼ˆé»æ“Šå¯è¤‡è£½ï¼‰</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<div id="toast" class="copy-toast">í ½í³‹ åœ°å€å·²è¤‡è£½</div>

<script>
const citySelect = document.getElementById('citySelect');
const townSelect = document.getElementById('townSelect');
const updateTimeDiv = document.getElementById('updateTime');
const noDataMessage = document.getElementById('noDataMessage');
const cateContainer = document.getElementById('cateContainer');
const scateContainer = document.getElementById('scateContainer');
const nameContainer = document.getElementById('nameContainer');
const resultTable = document.getElementById('resultTable');
const resultBody = resultTable.querySelector('tbody');
const toast = document.getElementById('toast');
const infoBox = document.getElementById('infoBox');
const showCate = document.getElementById('showCate');
const showItem = document.getElementById('showItem');

let allZipData = [];
let allData = [];
let selectedCate = null, selectedScate = null, selectedName = null;

function formatTimestamp(ts) {
  const date = new Date(ts * 1000);
  return date.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
}
function showToast() {
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 1200);
}
function copyToClipboard(text, row) {
  navigator.clipboard.writeText(text).then(() => {
    row.classList.add('copied');
    showToast();
    setTimeout(() => row.classList.remove('copied'), 800);
  });
}

// è¼‰å…¥ zipcode.json
async function loadZipData() {
  const res = await fetch('/family/zipcode.json');
  allZipData = await res.json();
  const cities = [...new Set(allZipData.map(z => z.city))];
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    citySelect.appendChild(opt);
  });
}

citySelect.addEventListener('change', () => {
  const city = citySelect.value;
  townSelect.innerHTML = '<option value="">-- é¸æ“‡å€åŸŸ --</option>';
  townSelect.disabled = true;
  cateContainer.innerHTML = scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  updateTimeDiv.style.display = 'none';
  noDataMessage.style.display = 'none';
  infoBox.style.display = 'none';
  if (!city) return;

  const towns = allZipData.filter(z => z.city === city);
  towns.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.town;
    opt.textContent = t.town;
    townSelect.appendChild(opt);
  });
  townSelect.disabled = false;
});

// towné¸æ“‡å¾Œè®€å–å°æ‡‰å€åŸŸæª”æ¡ˆ
townSelect.addEventListener('change', async () => {
  const city = citySelect.value;
  const town = townSelect.value;
  const zipInfo = allZipData.find(z => z.city === city && z.town === town);
  cateContainer.innerHTML = scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  updateTimeDiv.style.display = 'none';
  noDataMessage.style.display = 'none';
  infoBox.style.display = 'none';
  if (!zipInfo) return;

  try {
    const zipcode = zipInfo.zipcode;
    const res = await fetch(`/family/data/${zipcode}.json`);
    const json = await res.json();

    allData = json.data || [];
    updateTimeDiv.textContent = 'è³‡æ–™æ›´æ–°æ™‚é–“ï¼š' + formatTimestamp(json.updatetime);
    updateTimeDiv.style.display = 'block';

    // ç„¡è³‡æ–™æƒ…æ³è™•ç†
    if (!allData || allData.length === 0 || allData.every(s => !s.data || s.data.length === 0)) {
      noDataMessage.style.display = 'block';
      return;
    }

    const cates = [...new Set(allData.flatMap(d => d.data.map(i => i.cate)).filter(Boolean))];
    cateContainer.innerHTML = '<h4>é¸æ“‡é¡åˆ¥ï¼š</h4><div class="radio-group">' +
      cates.map(c => `<div class="radio-btn" data-value="${c}">${c}</div>`).join('') + '</div>';

    cateContainer.querySelectorAll('.radio-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        cateContainer.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCate = btn.dataset.value;
        selectedScate = selectedName = null;
        showScateOptions(selectedCate);
      });
    });
  } catch (err) {
    console.error('è®€å–å€åŸŸè³‡æ–™å¤±æ•—ï¼š', err);
    noDataMessage.textContent = 'âš ï¸ ç„¡æ³•è¼‰å…¥æ­¤å€åŸŸè³‡æ–™';
    noDataMessage.style.display = 'block';
  }
});

function showScateOptions(cate) {
  scateContainer.innerHTML = nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';
  noDataMessage.style.display = 'none';

  const scates = [...new Set(allData.flatMap(d =>
    d.data.filter(i => i.cate === cate).map(i => i.scate)
  ).filter(Boolean))];

  scateContainer.innerHTML = '<h4>é¸æ“‡æ¬¡åˆ†é¡ï¼š</h4><div class="radio-group">' +
    scates.map(s => `<div class="radio-btn" data-value="${s}">${s}</div>`).join('') + '</div>';

  scateContainer.querySelectorAll('.radio-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      scateContainer.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedScate = btn.dataset.value;
      selectedName = null;
      showNameOptions(selectedCate, selectedScate);
    });
  });
}

/* ========== é€™è£¡æ˜¯æ–°çš„ auto-smart ç¾¤çµ„èˆ‡é¡¯ç¤º showNameOptions() ========== */

// è‡ªå‹•åµæ¸¬é«˜é »å‰ç¶´ä¸¦åˆ†ç¾¤ï¼ˆ2~5å­—ï¼‰
// é–€æª»ç‚º count >= 5ï¼ˆå¯èª¿ï¼‰
function autoSmartGroupProducts(names, threshold = 5) {
  const prefixCount = {};
  names.forEach(name => {
    const clean = String(name).replace(/[\(\)\[\]ã€ã€‘â˜…â˜†\s]/g, '');
    for (let len = 2; len <= 8 && len <= clean.length; len++) {
      const prefix = clean.slice(0, len);
      prefixCount[prefix] = (prefixCount[prefix] || 0) + 1;
    }
  });

  // å€™é¸å‰ç¶´ï¼ˆå‡ºç¾æ¬¡æ•¸ >= thresholdï¼‰
  const candidates = Object.entries(prefixCount)
    .filter(([p, c]) => c >= threshold)
    .sort((a, b) => b[0].length - a[0].length || b[1] - a[1])
    .map(([p]) => p);

  const grouped = {};
  names.forEach(name => {
    const clean = String(name).replace(/[\(\)\[\]ã€ã€‘â˜…â˜†\s]/g, '');
    let matchedPrefix = null;
    for (const p of candidates) {
      if (clean.startsWith(p)) { matchedPrefix = p; break; }
    }
    const groupName = matchedPrefix || 'å…¶ä»–';
    if (!grouped[groupName]) grouped[groupName] = [];
    grouped[groupName].push(name);
  });

  // æ’åºæ¯å€‹ç¾¤çµ„å…§çš„é …ç›®
  Object.keys(grouped).forEach(k => {
    grouped[k].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
  });

  // âœ… ç¾¤çµ„æ’åºï¼šä¸­æ–‡é †åº + å°‡ã€Œå…¶ä»–ã€æ°¸é æ”¾æœ€å¾Œ
  const sortedEntries = Object.entries(grouped).sort((a, b) => {
    if (a[0] === 'å…¶ä»–') return 1;
    if (b[0] === 'å…¶ä»–') return -1;
    return a[0].localeCompare(b[0], 'zh-Hant');
  });

  return Object.fromEntries(sortedEntries);
}


function showNameOptions(cate, scate) {
  nameContainer.innerHTML = '';
  resultTable.style.display = 'none';
  infoBox.style.display = 'none';

  const names = [...new Set(allData
    .flatMap(d => d.data.filter(i => i.cate === cate && i.scate === scate).map(i => i.name))
    .filter(Boolean))];

  if (names.length === 0) {
    nameContainer.innerHTML = '<p>æ­¤åˆ†é¡ç›®å‰ç„¡å•†å“ã€‚</p>';
    return;
  }

  // 1) ç”¨è‡ªå‹•åˆ†ç¾¤å™¨æŠŠåç¨±åˆ†çµ„
  const grouped = autoSmartGroupProducts(names, 3); // é–€æª» 5ï¼Œå¯æ”¹æˆ 4 æˆ– 3 å¯¦é©—

  // 2) å»ºç«‹ç¾¤çµ„ UI
  nameContainer.innerHTML = '<h4>é¸æ“‡å•†å“ï¼š</h4><div class="group-container"></div>';
  const container = nameContainer.querySelector('.group-container');

  Object.keys(grouped).forEach(group => {
    const header = document.createElement('div');
    header.className = 'group-header';
    header.textContent = `${group}ï¼ˆ${grouped[group].length}é …ï¼‰`;

    const list = document.createElement('div');
    list.className = 'group-list';
    list.style.display = 'none';
    list.innerHTML = grouped[group].map(n => `<div class="radio-btn" data-value="${escapeHtml(n)}">${escapeHtml(n)}</div>`).join('');

    header.addEventListener('click', () => {
      // æ”¶åˆå…¶ä»– group-listï¼Œæ‰‹é¢¨ç´æ–¹å¼
      const allLists = container.querySelectorAll('.group-list');
      allLists.forEach(l => { if (l !== list) l.style.display = 'none'; });
      list.style.display = list.style.display === 'block' ? 'none' : 'block';
    });

    container.appendChild(header);
    container.appendChild(list);
  });

  // 3) ç¶å®šæ¯å€‹ radio-btn çš„ clickï¼ˆæ³¨æ„å…ˆç”Ÿæˆ DOM å†ç¶ï¼‰
  container.querySelectorAll('.radio-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const val = btn.getAttribute('data-value');
      // åè½‰ç¾© HTML å¯¦éš›å€¼
      const realVal = unescapeHtml(val);
      // æ¨£å¼
      container.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedName = realVal;
      showResults(cate, selectedName);
    });
  });
}

// å°å·¥å…·ï¼šç‚ºäº†é¿å…æ’å…¥æœªè½‰ç¾©æ–‡å­—é€ æˆ HTML å•é¡Œï¼ŒHTML escape/unescape
function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
function unescapeHtml(escaped) {
  return String(escaped)
    .replace(/&amp;/g, '&')
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&quot;/g, '"')
    .replace(/&#039;/g, "'");
}

/* ========== ä»¥ä¸Šç‚ºæ–°çš„ç¾¤çµ„ UI èˆ‡é‚è¼¯ ========== */

function showResults(cate, item) {
  resultBody.innerHTML = '';
  const stores = allData.filter(d =>
    d.data.some(i => i.name === item && i.cate === cate)
  );

  if (stores.length === 0) {
    resultTable.style.display = 'none';
    infoBox.style.display = 'none';
    return;
  }

  showCate.textContent = cate;
  showItem.textContent = item;
  infoBox.style.display = '';
  resultTable.style.display = '';

  stores.forEach(store => {
    const matched = store.data.find(i => i.name === item && i.cate === cate);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="clickable">${store.id}</td>
      <td class="clickable">${store.name}</td>
      <td>${matched ? matched.qty : ''}</td>
      <td class="address">${store.address}</td>
    `;

    const collapseRow = document.createElement('tr');
    collapseRow.classList.add('collapsible-row');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.classList.add('collapsible-content');
    td.innerHTML = createProductTable(store.data, item);
    collapseRow.appendChild(td);

    tr.querySelector('.address').addEventListener('click', () => copyToClipboard(store.address, tr));
    tr.querySelectorAll('.clickable').forEach(cell => {
      cell.addEventListener('click', () => {
        const allCollapses = resultBody.querySelectorAll('.collapsible-row');
        allCollapses.forEach(r => { if (r !== collapseRow) r.style.display = 'none'; });
        collapseRow.style.display = (collapseRow.style.display === 'table-row') ? 'none' : 'table-row';
      });
    });

    resultBody.appendChild(tr);
    resultBody.appendChild(collapseRow);
  });
}

function createProductTable(data, selectedItem) {
  if (!data || data.length === 0) return '<em>ç„¡å•†å“è³‡æ–™</em>';
  let rows = data.map(i =>
    `<tr class="${i.name === selectedItem ? 'highlight' : ''}">
      <td>${i.cate}</td><td>${i.scate}</td><td>${escapeHtml(i.name)}</td><td>${i.qty}</td>
    </tr>`
  ).join('');
  return `
    <table>
      <thead><tr><th>é¡åˆ¥</th><th>æ¬¡åˆ†é¡</th><th>å•†å“åç¨±</th><th>æ•¸é‡</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

loadZipData();
</script>
</body>
</html>
